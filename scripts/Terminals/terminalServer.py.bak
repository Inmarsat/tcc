#!/usr/bin/python
import urllib2
import argparse
import subprocess
import json
import os.path
import os
import socket
import fcntl
import struct
from pyroute2 import netns
from pyroute2 import NetNS
from pyroute2 import IPDB
from pprint import pprint
from BaseHTTPServer import BaseHTTPRequestHandler,HTTPServer

class SendHTTPData:
   def __init__(self, data, method, HOST, PORT, action):
       self.connection = 'http://' + HOST + ':' + PORT + '/' + action
       self.data = data

   def send(self):
       req = urllib2.Request(self.connection)
       req.add_header('Content-Type', 'application/json')
       response = urllib2.urlopen(req, json.dumps(self.data))
       return json.loads(response.read())

class Handler(BaseHTTPRequestHandler):

    def do_GET(self):
        if format == 'html':
            self.send_response(200)
            self.send_header("Content-type", "application/json")
            self.end_headers()
            self.wfile.write("body")
        elif format == 'json':
            self.request.sendall(json.dumps({'path':self.path}))
        else:
            self.request.sendall("%s\t%s" %('path', self.path))
        return

    def do_POST(self):
        self.data_string = self.rfile.read(int(self.headers['Content-Length']))
        data = json.loads(self.data_string)
        if self.path == '/createSERVICE':
            print data
            result = createService(data['Name'],data['Terminal'], data['Id'])
            self.request.sendall(result)
        if self.path == '/changeSERVICE':
            print data
            result = changeService(data['Name'],data['Terminal'], data['Id'])
            self.request.sendall(result)
        if self.path == '/deleteSERVICE':
            print data
            result = deleteService(data['Name'],data['Terminal'])
            self.request.sendall(result)
        if self.path == '/createEP':
            print data
            result = createEndpoint(data['Name'],data['Service'])
            self.request.sendall(result)
        if self.path == '/deleteEP':
            print data
            result = deleteEndpoint(data['Name'],data['Service'])
            self.request.sendall(result)
        if self.path == '/moveTERMINAL':
            print data
            result = moveTerminal(data)
            self.request.sendall(result)

def createService(name, terminalName, svcId):
    subprocess.call(["ovs-vsctl", "add-br", "vs-" + name])
    if_svc_name = name
    if_terminal_name = name + '_' + terminalName
    ip_host = IPDB()
    ip_host.create(ifname=if_svc_name, kind='veth', peer=if_terminal_name).commit()
    with ip_host.interfaces[if_svc_name] as veth:
        veth.up()
    with ip_host.interfaces[if_terminal_name] as veth:
        veth.up()
    ip_host.release()
    subprocess.call(["ovs-vsctl", "add-port", "vs-" + name, if_svc_name])
    subprocess.call(["ovs-vsctl", "add-port", "br0", if_terminal_name])
    subprocess.call(["ovs-vsctl", "set", "port", if_terminal_name, "tag=" + str(svcId)])
    return json.dumps({ 'status' : 'created service'})

def moveTerminal(data):
    subprocess.call(['ovs-vsctl', 'del-port', 'br0', data['OldPp']])
    subprocess.call(['ovs-vsctl', 'add-port', 'br0', data['Pp'], '--', 'set', 'interface', data['Pp'], 'type=vxlan', 'options:remote_ip='+data['PpVxlanIp']])
    return json.dumps({ 'status' : 'terminal nmoved'})

def changeService(name, terminalName, svcId):
    if_terminal_name = name + '_' + terminalName
    subprocess.call(["ovs-vsctl", "set", "port", if_terminal_name, "tag=" + str(svcId)])
    return json.dumps({ 'status' : 'changed service'})

def deleteService(name, terminalName):
    if_svc_name = name
    if_terminal_name = name + '_' + terminalName
    ip_host = IPDB()
    with ip_host.interfaces[if_terminal_name] as veth:
        veth.remove()
    ip_host.release()
    subprocess.call(["ovs-vsctl", "del-port", "vs-" + name, if_svc_name])
    subprocess.call(["ovs-vsctl", "del-port", "br0", if_terminal_name])
    subprocess.call(["ovs-vsctl", "del-br", "vs-" + name])
    return json.dumps({ 'status' : 'deleted service'})

def createEndpoint(name, svcName):
    ip_host = IPDB()
    ip_host.create(ifname=name, kind='veth', peer=name + '_' + svcName).commit()
    ip_ns = IPDB(nl=NetNS(name))
    with ip_host.interfaces[name] as veth:
        veth.net_ns_fd = name
        veth.up()
    with ip_host.interfaces[name + '_' + svcName] as veth:
        veth.up()
    ip_host.release()
    ip_ns.release()
    subprocess.call(["ovs-vsctl", "add-port", "vs-" + svcName, name + '_' + svcName])
    return json.dumps({ 'status' : 'created endpoint'})

def deleteEndpoint(name, svcName):
    netns.remove(name)
    ip_host = IPDB()
    if name + '_' + svcName in ip_host.interfaces:
        with ip_host.interfaces[name + '_' + svcName] as veth:
            veth.remove()
    subprocess.call(["ovs-vsctl", "del-port", "vs-" + svcName, name + '_' + svcName])
    return json.dumps({ 'status' : 'deleted endpoint'})

def get_ip_address(ifname):
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    return socket.inet_ntoa(fcntl.ioctl(
        s.fileno(),
        0x8915,  # SIOCGIFADDR
        struct.pack('256s', ifname[:15])
    )[20:24])

def setTunnel():
    f = open('/etc/hostname','r')
    hostname = f.read()
    f.close
    hostname = hostname.rstrip()
    data = json.dumps({'Name':hostname})
    result = SendHTTPData(data=data, method='POST',HOST='192.168.1.66',PORT='6666',action='pullTerminalConfig').send()
    subprocess.call(['ovs-vsctl', 'add-port', 'br0', result['pp'], '--', 'set', 'interface', result['pp'], 'type=vxlan', 'options:remote_ip='+result['ip']])

HOST = get_ip_address('eth0')
PORT = 3288

if __name__ == "__main__":
    setTunnel()
    server_address = (HOST, PORT)
    httpd = HTTPServer(server_address, Handler)
    print "Serving at: http://%s:%s" % (HOST, PORT)
    httpd.serve_forever()
